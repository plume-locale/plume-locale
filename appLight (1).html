<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plume — Mode Light</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,300;8..60,400;8..60,500;8..60,600;8..60,700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════
   CSS VARIABLES — PLUME LIGHT THEME
   ═══════════════════════════════════════════ */
:root {
  /* Surface */
  --bg-app: #faf9f7;
  --bg-surface: #ffffff;
  --bg-surface-alt: #fdfcfa;
  --bg-hover: #f8f5f1;
  --bg-active: #f5f0eb;
  --bg-atelier: #fdfcfa;
  --bg-editor: #faf9f7;

  /* Borders */
  --border: #e8e4df;
  --border-light: #f0ece7;
  --border-input: #e0dbd5;
  --border-accent: #d4c9b8;

  /* Text */
  --text-primary: #2c2825;
  --text-secondary: #4a4540;
  --text-tertiary: #6b6560;
  --text-muted: #8b8580;
  --text-faint: #a09a94;
  --text-ghost: #c5bfb8;
  --text-placeholder: #b5b0aa;

  /* Accent — warm gold */
  --accent: #8b7355;
  --accent-hover: #7a644a;
  --accent-light: #faf5ef;
  --accent-gradient: linear-gradient(90deg, #8b7355, #a68b5b);

  /* Status */
  --status-draft: #94a3b8;
  --status-progress: #f59e0b;
  --status-done: #22c55e;
  --status-revise: #ef4444;

  /* Fonts */
  --font-serif: 'Source Serif 4', Georgia, 'Times New Roman', serif;
  --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;

  /* Sizing */
  --header-h: 48px;
  --sidebar-w: 260px;
  --sidebar-collapsed-w: 52px;
  --breadcrumb-h: 36px;

  /* Transitions */
  --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
  --t-fast: 0.12s;
  --t-normal: 0.2s;
  --t-smooth: 0.25s;
}

/* ═══════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--font-sans);
  color: var(--text-primary);
  background: var(--bg-app);
  -webkit-font-smoothing: antialiased;
}
button { font-family: inherit; cursor: pointer; border: none; background: none; color: inherit; }
input { font-family: inherit; border: none; outline: none; background: none; }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-ghost); }

/* ═══════════════════════════════════════════
   APP SHELL
   ═══════════════════════════════════════════ */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100vw;
}

/* ═══════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════ */
#header {
  height: var(--header-h);
  min-height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  z-index: 100;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}
.header-logo {
  font-family: var(--font-serif);
  font-weight: 600;
  font-size: 18px;
  color: var(--accent);
  letter-spacing: -0.02em;
  flex-shrink: 0;
}
.header-sep {
  width: 1px;
  height: 20px;
  background: var(--border-input);
  flex-shrink: 0;
}
.header-project {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-tertiary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.header-badge {
  font-size: 10px;
  font-weight: 500;
  padding: 2px 6px;
  border-radius: 4px;
  flex-shrink: 0;
}
.header-badge.saved { color: var(--status-done); background: #f0fdf4; }

.header-center {
  display: flex;
  align-items: center;
  gap: 2px;
}

.h-icon-btn {
  position: relative;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  color: var(--text-muted);
  transition: background var(--t-fast) var(--ease-out), color var(--t-fast) var(--ease-out);
}
.h-icon-btn:hover { background: var(--bg-active); color: var(--text-tertiary); }
.h-icon-btn.active { background: var(--bg-active); color: var(--accent); }
.h-icon-btn svg { width: 16px; height: 16px; }

.h-divider {
  width: 1px;
  height: 18px;
  background: var(--border);
  margin: 0 6px;
}

.search-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  height: 30px;
  padding: 0 10px;
  border: 1px solid var(--border-input);
  background: var(--bg-app);
  border-radius: 6px;
  font-size: 12px;
  color: var(--text-muted);
  transition: border-color var(--t-fast), color var(--t-fast);
}
.search-btn:hover { border-color: var(--border-accent); color: var(--text-tertiary); }
.search-btn svg { width: 14px; height: 14px; }
.search-btn kbd {
  font-family: var(--font-sans);
  font-size: 10px;
  color: var(--text-placeholder);
  margin-left: 12px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}
.header-wordcount {
  font-size: 11px;
  color: var(--text-faint);
}
.header-wordcount strong {
  color: var(--text-tertiary);
  font-weight: 500;
}

/* Overflow menu */
.overflow-menu {
  position: absolute;
  top: 40px;
  right: 0;
  background: var(--bg-surface);
  border: 1px solid var(--border-input);
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  padding: 6px;
  min-width: 210px;
  z-index: 200;
  display: none;
}
.overflow-menu.open { display: block; }
.overflow-menu .menu-item {
  display: block;
  width: 100%;
  padding: 7px 12px;
  font-size: 13px;
  color: var(--text-tertiary);
  border-radius: 5px;
  text-align: left;
  transition: background var(--t-fast);
}
.overflow-menu .menu-item:hover { background: var(--bg-hover); }
.overflow-menu .menu-divider {
  height: 1px;
  background: var(--border-light);
  margin: 4px 8px;
}

/* ═══════════════════════════════════════════
   MAIN BODY (sidebar + editor)
   ═══════════════════════════════════════════ */
#main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ═══════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════ */
#sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  background: var(--bg-surface);
  transition: width var(--t-smooth) var(--ease-out), min-width var(--t-smooth) var(--ease-out);
  overflow: hidden;
}
#sidebar.collapsed {
  width: var(--sidebar-collapsed-w);
  min-width: var(--sidebar-collapsed-w);
}

/* Tab rail */
.tab-rail {
  display: flex;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.collapsed .tab-rail {
  flex-direction: column;
  border-bottom: none;
  padding: 8px 6px;
  gap: 2px;
}

.tab-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  height: 40px;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-faint);
  border-bottom: 2px solid transparent;
  transition: color var(--t-fast), border-color var(--t-fast);
  position: relative;
}
.tab-btn:hover { color: var(--text-tertiary); }
.tab-btn.active {
  color: var(--accent);
  font-weight: 600;
  border-bottom-color: var(--accent);
}
.tab-btn svg { width: 16px; height: 16px; }
.tab-btn .tab-label { pointer-events: none; }

/* Collapsed tab buttons */
.collapsed .tab-btn {
  flex: none;
  width: 40px;
  height: 38px;
  border-bottom: none;
  border-radius: 6px;
}
.collapsed .tab-btn.active {
  background: var(--bg-active);
  border-bottom: none;
}
.collapsed .tab-btn:hover { background: var(--bg-hover); }
.collapsed .tab-btn .tab-label { display: none; }

/* Tooltip for collapsed */
.tooltip-text {
  display: none;
  position: absolute;
  left: 48px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  color: #fff;
  background: #3c3835;
  padding: 3px 8px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 50;
  pointer-events: none;
}
.collapsed .tab-btn:hover .tooltip-text { display: block; }

/* ─── Atelier Drawer ─── */
.atelier-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-placeholder);
  transition: background var(--t-fast), color var(--t-fast);
}
.atelier-toggle:hover { color: var(--text-muted); }
.atelier-toggle.open { background: var(--accent-light); color: var(--accent); }
.atelier-toggle .chevron {
  display: flex;
  transition: transform var(--t-normal);
}
.atelier-toggle.open .chevron { transform: rotate(90deg); }
.atelier-toggle .atelier-hint {
  margin-left: auto;
  font-size: 10px;
  font-weight: 400;
  color: var(--text-ghost);
  text-transform: none;
  letter-spacing: 0;
}
.collapsed .atelier-toggle { display: none; }

.atelier-panel {
  display: none;
  flex-wrap: wrap;
  gap: 4px;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-atelier);
}
.atelier-panel.open { display: flex; }

.atelier-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 10px;
  font-size: 12px;
  color: var(--text-muted);
  border: 1px solid transparent;
  border-radius: 6px;
  transition: all var(--t-fast);
}
.atelier-btn:hover {
  background: var(--bg-active);
  color: var(--text-tertiary);
}
.atelier-btn.active {
  background: var(--bg-surface);
  color: var(--accent);
  border-color: var(--border-accent);
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.atelier-btn svg { width: 16px; height: 16px; }

/* ─── Sidebar Content ─── */
.sidebar-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px 0;
}
.collapsed .sidebar-content { display: none; }

/* New chapter button */
.new-chapter-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  width: calc(100% - 20px);
  margin: 0 10px 8px;
  height: 30px;
  border: 1px dashed var(--border-accent);
  font-size: 12px;
  font-weight: 500;
  color: var(--accent);
  border-radius: 6px;
  transition: background var(--t-fast), border-style var(--t-fast);
}
.new-chapter-btn:hover { background: var(--accent-light); border-style: solid; }
.new-chapter-btn svg { width: 14px; height: 14px; }

/* Chapter tree */
.chapter-header {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 10px;
  font-size: 12.5px;
  font-weight: 600;
  color: var(--text-secondary);
  text-align: left;
  transition: background var(--t-fast);
}
.chapter-header:hover { background: var(--bg-hover); }
.chapter-header .ch-chevron {
  display: flex;
  color: var(--text-faint);
  transition: transform 0.15s var(--ease-out);
}
.chapter-header .ch-chevron.open { transform: rotate(90deg); }
.chapter-header .ch-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.chapter-header .ch-count {
  font-size: 10px;
  color: var(--text-ghost);
  font-weight: 400;
}

.chapter-scenes { display: none; padding-bottom: 4px; }
.chapter-scenes.open { display: block; }

.scene-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px 6px 32px;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-tertiary);
  text-align: left;
  border-left: 2px solid transparent;
  transition: all var(--t-fast);
}
.scene-btn:hover { background: var(--bg-hover); }
.scene-btn.active {
  background: var(--bg-active);
  color: var(--text-secondary);
  font-weight: 500;
  border-left-color: var(--accent);
}
.scene-btn .scene-dot {
  width: 7px;
  height: 7px;
  min-width: 7px;
  border-radius: 50%;
  opacity: 0.8;
}
.scene-btn .scene-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.scene-btn .scene-words {
  font-size: 10px;
  color: var(--text-ghost);
  font-weight: 400;
  font-variant-numeric: tabular-nums;
}

.add-scene-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 10px 5px 32px;
  font-size: 11px;
  color: var(--text-ghost);
  transition: color var(--t-fast);
}
.add-scene-btn:hover { color: var(--accent); }
.add-scene-btn svg { width: 12px; height: 12px; }

/* ─── Characters panel ─── */
.panel-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-faint);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 4px 14px 10px;
}
.char-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  border-radius: 6px;
  margin: 0 4px 2px;
  cursor: pointer;
  transition: background var(--t-fast);
}
.char-item:hover { background: var(--bg-hover); }
.char-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  flex-shrink: 0;
}
.char-info-name { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
.char-info-role { font-size: 11px; color: var(--text-faint); }

/* ─── Generic panel placeholder ─── */
.panel-placeholder {
  padding: 40px 20px;
  text-align: center;
}
.panel-placeholder .ph-title {
  font-size: 13px;
  color: var(--text-faint);
  margin-bottom: 4px;
}
.panel-placeholder .ph-title strong { color: var(--text-tertiary); }
.panel-placeholder .ph-sub { font-size: 12px; color: var(--text-ghost); }

/* ─── Sidebar Footer ─── */
.sidebar-footer {
  border-top: 1px solid var(--border);
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.collapsed .sidebar-footer { padding: 8px 6px; justify-content: center; }

.collapse-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  color: var(--text-faint);
  transition: color var(--t-fast);
  flex-shrink: 0;
}
.collapse-btn:hover { color: var(--text-tertiary); }
.collapse-btn svg { width: 14px; height: 14px; }

.progress-bar-wrap { flex: 1; min-width: 0; }
.collapsed .progress-bar-wrap { display: none; }
.progress-meta {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-faint);
  margin-bottom: 3px;
}
.progress-track {
  height: 3px;
  background: var(--border-light);
  border-radius: 2px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--accent-gradient);
  border-radius: 2px;
  transition: width 0.5s var(--ease-out);
}

/* ═══════════════════════════════════════════
   EDITOR AREA
   ═══════════════════════════════════════════ */
#editor-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

/* Breadcrumb */
.breadcrumb-bar {
  height: var(--breadcrumb-h);
  min-height: var(--breadcrumb-h);
  display: flex;
  align-items: center;
  padding: 0 24px;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-surface-alt);
  font-size: 12px;
  color: var(--text-faint);
  gap: 6px;
}
.breadcrumb-bar .bc-sep { color: var(--text-ghost); }
.breadcrumb-bar .bc-current { color: var(--text-secondary); font-weight: 500; }
.bc-status {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  margin-left: 8px;
}
.bc-status .bc-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
}
.bc-spacer { flex: 1; }
.bc-wordcount { font-size: 11px; color: var(--text-ghost); }

/* Editor scroll area */
.editor-scroll {
  flex: 1;
  overflow-y: auto;
  display: flex;
  justify-content: center;
  padding: 40px 24px 80px;
}
.editor-container {
  width: 100%;
  max-width: 680px;
}

/* Content editable zone */
.editor-title {
  font-family: var(--font-serif);
  font-size: 26px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 24px;
  letter-spacing: -0.01em;
  outline: none;
  border: none;
}
.editor-title:empty::before {
  content: 'Titre de la scène…';
  color: var(--text-placeholder);
}

.editor-body {
  font-family: var(--font-serif);
  font-size: 17px;
  line-height: 1.85;
  color: #3c3835;
  letter-spacing: 0.005em;
  outline: none;
  min-height: 300px;
}
.editor-body p {
  margin-bottom: 20px;
  text-indent: 24px;
}
.editor-body p:first-child { text-indent: 0; }
.editor-body:empty::before {
  content: 'Commencez à écrire…';
  color: var(--text-placeholder);
  font-style: italic;
}

/* ─── Formatting Toolbar (sticky above editor) ─── */
.format-toolbar {
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 6px 0;
  margin-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
  position: sticky;
  top: 0;
  background: var(--bg-editor);
  z-index: 10;
}
.fmt-btn {
  width: 30px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 600;
  transition: background var(--t-fast), color var(--t-fast);
}
.fmt-btn:hover { background: var(--bg-active); color: var(--text-secondary); }
.fmt-btn.active { background: var(--bg-active); color: var(--accent); }
.fmt-sep { width: 1px; height: 18px; background: var(--border-light); margin: 0 4px; }

/* ═══════════════════════════════════════════
   SEARCH MODAL (global)
   ═══════════════════════════════════════════ */
.search-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  z-index: 500;
  justify-content: center;
  padding-top: 18vh;
}
.search-overlay.open { display: flex; }
.search-modal {
  width: 520px;
  max-height: 400px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 16px 48px rgba(0,0,0,0.12);
  overflow: hidden;
  animation: searchIn 0.15s var(--ease-out);
}
@keyframes searchIn {
  from { opacity: 0; transform: translateY(-8px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.search-input-wrap {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-light);
}
.search-input-wrap svg { width: 18px; height: 18px; color: var(--text-faint); flex-shrink: 0; }
.search-input-wrap input {
  flex: 1;
  font-size: 15px;
  color: var(--text-primary);
}
.search-input-wrap input::placeholder { color: var(--text-placeholder); }
.search-hint {
  padding: 20px 16px;
  font-size: 13px;
  color: var(--text-faint);
  text-align: center;
}

/* ═══════════════════════════════════════════
   POMODORO MINI POPUP
   ═══════════════════════════════════════════ */
.pomo-popup {
  display: none;
  position: fixed;
  top: var(--header-h);
  right: 80px;
  width: 240px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  padding: 16px;
  z-index: 200;
  text-align: center;
}
.pomo-popup.open { display: block; }
.pomo-time {
  font-family: var(--font-sans);
  font-size: 32px;
  font-weight: 300;
  color: var(--text-primary);
  margin: 8px 0;
  font-variant-numeric: tabular-nums;
}
.pomo-label {
  font-size: 11px;
  color: var(--text-faint);
  margin-bottom: 12px;
}
.pomo-actions {
  display: flex;
  gap: 6px;
  justify-content: center;
}
.pomo-btn {
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  transition: background var(--t-fast);
}
.pomo-btn.primary {
  background: var(--accent);
  color: #fff;
}
.pomo-btn.primary:hover { background: var(--accent-hover); }
.pomo-btn.secondary {
  background: var(--bg-app);
  color: var(--text-tertiary);
  border: 1px solid var(--border-input);
}
.pomo-btn.secondary:hover { background: var(--bg-hover); }

/* ═══════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════ */
@media (max-width: 768px) {
  .header-project, .search-btn kbd, .header-badge { display: none; }
  .search-btn { padding: 0 8px; }
  #sidebar { width: var(--sidebar-collapsed-w); min-width: var(--sidebar-collapsed-w); }
  #sidebar .tab-rail { flex-direction: column; border-bottom: none; padding: 8px 6px; gap: 2px; }
  #sidebar .tab-btn { flex: none; width: 40px; height: 38px; border-bottom: none; border-radius: 6px; }
  #sidebar .tab-btn .tab-label { display: none; }
  #sidebar .tab-btn:hover .tooltip-text { display: block; }
  #sidebar .tab-btn.active { background: var(--bg-active); border-bottom: none; }
  .atelier-toggle, .sidebar-content, .progress-bar-wrap { display: none; }
  .sidebar-footer { padding: 8px 6px; justify-content: center; }
  .editor-scroll { padding: 24px 16px 80px; }
  .breadcrumb-bar { padding: 0 16px; font-size: 11px; }
}
</style>
</head>
<body>

<div id="app">

  <!-- ═══════════ HEADER ═══════════ -->
  <header id="header">
    <div class="header-left">
      <span class="header-logo">plume</span>
      <span class="header-sep"></span>
      <span class="header-project" id="projectName">Mon Roman</span>
      <span class="header-badge saved" id="saveStatus">Sauvé</span>
    </div>

    <div class="header-center">
      <!-- Undo / Redo -->
      <button class="h-icon-btn" title="Annuler (Ctrl+Z)" onclick="document.execCommand('undo')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
      </button>
      <button class="h-icon-btn" title="Rétablir (Ctrl+Y)" onclick="document.execCommand('redo')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
      </button>

      <span class="h-divider"></span>

      <!-- Search -->
      <button class="search-btn" onclick="toggleSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span>Rechercher…</span>
        <kbd>Ctrl+F</kbd>
      </button>

      <span class="h-divider"></span>

      <!-- Save / Timer / Focus -->
      <button class="h-icon-btn" title="Sauvegarder (Ctrl+S)" onclick="saveProject()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>
      </button>
      <button class="h-icon-btn" id="pomoToggle" title="Pomodoro" onclick="togglePomo()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M9 2h6"/></svg>
      </button>
      <button class="h-icon-btn" title="Mode Focus (F11)" onclick="toggleFocus()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
      </button>
    </div>

    <div class="header-right">
      <span class="header-wordcount"><strong id="totalWords">4 666</strong> mots</span>
      <button class="h-icon-btn" id="moreBtn" onclick="toggleMore()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
      </button>
      <div class="overflow-menu" id="overflowMenu">
        <button class="menu-item">Importer un texte</button>
        <button class="menu-item">Exporter le roman</button>
        <button class="menu-item">Sauvegarde JSON</button>
        <div class="menu-divider"></div>
        <button class="menu-item">Snapshots</button>
        <button class="menu-item">Raccourcis clavier</button>
        <div class="menu-divider"></div>
        <button class="menu-item">Thèmes</button>
        <button class="menu-item">Personnaliser l'interface</button>
        <button class="menu-item">Langues</button>
      </div>
    </div>
  </header>

  <div id="main">

    <!-- ═══════════ SIDEBAR ═══════════ -->
    <aside id="sidebar">

      <!-- Tab Rail: 5 primary tabs -->
      <div class="tab-rail">
        <button class="tab-btn active" data-tab="write" onclick="switchTab('write', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
          <span class="tab-label">Écrire</span>
          <span class="tooltip-text">Écrire</span>
        </button>
        <button class="tab-btn" data-tab="tableau" onclick="switchTab('tableau', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          <span class="tab-label">Tableau</span>
          <span class="tooltip-text">Tableau</span>
        </button>
        <button class="tab-btn" data-tab="characters" onclick="switchTab('characters', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span class="tab-label">Personnages</span>
          <span class="tooltip-text">Personnages</span>
        </button>
        <button class="tab-btn" data-tab="notes" onclick="switchTab('notes', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z"/><path d="M15 3v4a2 2 0 0 0 2 2h4"/></svg>
          <span class="tab-label">Notes</span>
          <span class="tooltip-text">Notes</span>
        </button>
        <button class="tab-btn" data-tab="stats" onclick="switchTab('stats', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
          <span class="tab-label">Stats</span>
          <span class="tooltip-text">Stats</span>
        </button>
      </div>

      <!-- Atelier Drawer Toggle -->
      <button class="atelier-toggle" id="atelierToggle" onclick="toggleAtelier()">
        <span class="chevron">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </span>
        Atelier
        <span class="atelier-hint">Mindmap, Timeline, Carte…</span>
      </button>

      <!-- Atelier Panel (hidden by default) -->
      <div class="atelier-panel" id="atelierPanel">
        <button class="atelier-btn" data-tab="intrigue" onclick="switchTab('intrigue', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          Intrigue
        </button>
        <button class="atelier-btn" data-tab="arcs" onclick="switchTab('arcs', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20c2-4 6-12 10-12s8 8 10 12"/></svg>
          Arcs
        </button>
        <button class="atelier-btn" data-tab="mindmap" onclick="switchTab('mindmap', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><path d="M9.5 10.2 5.7 7.5"/><path d="M14.5 10.2 18.3 7.5"/><path d="M9.5 13.8 5.7 16.5"/><path d="M14.5 13.8 18.3 16.5"/></svg>
          Mindmap
        </button>
        <button class="atelier-btn" data-tab="relations" onclick="switchTab('relations', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12h8"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="12" r="3"/></svg>
          Relations
        </button>
        <button class="atelier-btn" data-tab="timeline" onclick="switchTab('timeline', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/><path d="M14 6h6"/><path d="M4 12h6"/><path d="M14 18h6"/></svg>
          Timeline
        </button>
        <button class="atelier-btn" data-tab="carte" onclick="switchTab('carte', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="m3 6 6-3 6 3 6-3v15l-6 3-6-3-6 3Z"/><path d="M9 3v15"/><path d="M15 6v15"/></svg>
          Carte
        </button>
        <button class="atelier-btn" data-tab="univers" onclick="switchTab('univers', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
          Univers
        </button>
        <button class="atelier-btn" data-tab="codex" onclick="switchTab('codex', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
          Codex
        </button>
      </div>

      <!-- Sidebar Content -->
      <div class="sidebar-content" id="sidebarContent">

        <!-- ▸ WRITE panel -->
        <div class="panel" id="panel-write">
          <button class="new-chapter-btn" onclick="alert('Créer un nouveau chapitre')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
            Nouveau chapitre
          </button>

          <!-- Chapters are generated by JS -->
          <div id="chapterTree"></div>
        </div>

        <!-- ▸ CHARACTERS panel -->
        <div class="panel" id="panel-characters" style="display:none">
          <div class="panel-title">Personnages principaux</div>
          <div id="charList"></div>
        </div>

        <!-- ▸ GENERIC panels -->
        <div class="panel" id="panel-tableau" style="display:none">
          <div class="panel-placeholder">
            <div class="ph-title">Vue : <strong>Tableau</strong></div>
            <div class="ph-sub">Affichage en grille des scènes (plot grid)</div>
          </div>
        </div>
        <div class="panel" id="panel-notes" style="display:none">
          <div class="panel-placeholder">
            <div class="ph-title">Vue : <strong>Notes</strong></div>
            <div class="ph-sub">Vos notes, TODOs et idées</div>
          </div>
        </div>
        <div class="panel" id="panel-stats" style="display:none">
          <div class="panel-placeholder">
            <div class="ph-title">Vue : <strong>Statistiques</strong></div>
            <div class="ph-sub">Compteurs, analyses et progression</div>
          </div>
        </div>

        <!-- Atelier panels -->
        <div class="panel atelier-view" id="panel-intrigue" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Intrigue</strong></div><div class="ph-sub">Plot grid et fils narratifs</div></div>
        </div>
        <div class="panel atelier-view" id="panel-arcs" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Arcs Narratifs</strong></div><div class="ph-sub">Courbes de tension et arcs de personnages</div></div>
        </div>
        <div class="panel atelier-view" id="panel-mindmap" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Mindmap</strong></div><div class="ph-sub">Carte mentale de votre roman</div></div>
        </div>
        <div class="panel atelier-view" id="panel-relations" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Relations</strong></div><div class="ph-sub">Graphe des relations entre personnages</div></div>
        </div>
        <div class="panel atelier-view" id="panel-timeline" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Timeline</strong></div><div class="ph-sub">Chronologie des événements</div></div>
        </div>
        <div class="panel atelier-view" id="panel-carte" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Carte</strong></div><div class="ph-sub">Carte géographique de votre univers</div></div>
        </div>
        <div class="panel atelier-view" id="panel-univers" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Univers</strong></div><div class="ph-sub">Lieux, objets, organisations</div></div>
        </div>
        <div class="panel atelier-view" id="panel-codex" style="display:none">
          <div class="panel-placeholder"><div class="ph-title">Vue : <strong>Codex</strong></div><div class="ph-sub">Encyclopédie de votre monde</div></div>
        </div>
      </div>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <div class="progress-bar-wrap">
          <div class="progress-meta">
            <span>Progression</span>
            <span id="progressPct">33%</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" id="progressFill" style="width: 33%"></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ═══════════ EDITOR ═══════════ -->
    <div id="editor-area">
      <!-- Breadcrumb -->
      <div class="breadcrumb-bar">
        <span id="bcAct">Acte I</span>
        <span class="bc-sep">/</span>
        <span id="bcChapter">L'Appel</span>
        <span class="bc-sep">/</span>
        <span class="bc-current" id="bcScene">La voix dans le brouillard</span>
        <span class="bc-status" id="bcStatus">
          <span class="bc-dot"></span>
          <span id="bcStatusLabel">En cours</span>
        </span>
        <span class="bc-spacer"></span>
        <span class="bc-wordcount"><span id="sceneWords">1 876</span> mots</span>
      </div>

      <!-- Editor -->
      <div class="editor-scroll">
        <div class="editor-container">
          <!-- Formatting toolbar -->
          <div class="format-toolbar">
            <button class="fmt-btn" title="Gras (Ctrl+B)" onclick="document.execCommand('bold')"><b>B</b></button>
            <button class="fmt-btn" title="Italique (Ctrl+I)" onclick="document.execCommand('italic')"><i>I</i></button>
            <button class="fmt-btn" title="Souligné (Ctrl+U)" onclick="document.execCommand('underline')"><u>U</u></button>
            <span class="fmt-sep"></span>
            <button class="fmt-btn" title="Titre H1" style="font-size:11px;" onclick="document.execCommand('formatBlock', false, 'h2')">H1</button>
            <button class="fmt-btn" title="Titre H2" style="font-size:11px;" onclick="document.execCommand('formatBlock', false, 'h3')">H2</button>
            <button class="fmt-btn" title="Citation" onclick="document.execCommand('formatBlock', false, 'blockquote')">❝</button>
            <span class="fmt-sep"></span>
            <button class="fmt-btn" title="Guillemet ouvrant «" onclick="insertText('« ')">«</button>
            <button class="fmt-btn" title="Guillemet fermant »" onclick="insertText(' »')">»</button>
            <button class="fmt-btn" title="Tiret cadratin —" onclick="insertText('— ')">—</button>
          </div>

          <!-- Editable title -->
          <div class="editor-title" contenteditable="true" id="editorTitle" spellcheck="true">La voix dans le brouillard</div>

          <!-- Editable body -->
          <div class="editor-body" contenteditable="true" id="editorBody" spellcheck="true">
            <p>Le brouillard s'épaississait entre les cèdres centenaires, avalant le sentier comme une créature vivante. Yuki serra les pans de son haori contre sa poitrine. Quelque part dans cette brume, une voix l'appelait — pas avec des mots, mais avec quelque chose de plus ancien que le langage.</p>
            <p>Elle aurait dû rebrousser chemin. C'était ce que la raison lui commandait, ce que sa grand-mère lui avait toujours répété : <em>« Quand la montagne te parle, ne réponds pas. »</em> Mais la voix ne venait pas de la montagne. Elle venait de l'intérieur.</p>
            <p>Un torii vermillon apparut dans la brume, ses piliers inclinés comme des os fatigués. La peinture s'écaillait par plaques, révélant le bois gris en dessous. Personne n'avait entretenu ce sanctuaire depuis des décennies. Et pourtant…</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ SEARCH OVERLAY ═══════════ -->
<div class="search-overlay" id="searchOverlay" onclick="if(event.target===this)toggleSearch()">
  <div class="search-modal">
    <div class="search-input-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="searchInput" placeholder="Rechercher dans le manuscrit…" autofocus>
    </div>
    <div class="search-hint">Tapez pour rechercher dans tous les chapitres et scènes</div>
  </div>
</div>

<!-- ═══════════ POMODORO POPUP ═══════════ -->
<div class="pomo-popup" id="pomoPopup">
  <div class="pomo-label">Pomodoro</div>
  <div class="pomo-time" id="pomoTime">25:00</div>
  <div class="pomo-label"><span id="pomoSessions">0</span> sessions</div>
  <div class="pomo-actions">
    <button class="pomo-btn primary" id="pomoStartBtn" onclick="startPomo()">Démarrer</button>
    <button class="pomo-btn secondary" onclick="resetPomo()">Reset</button>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════
   DATA — sample project structure
   ═══════════════════════════════════════════ */
const PROJECT = {
  name: 'Chroniques du Sanctuaire',
  chapters: [
    {
      id: 'ch1', title: 'Acte I — L\'Appel', open: true,
      scenes: [
        { id: 's1-1', title: 'Le sanctuaire oublié', status: 'done', words: 2340 },
        { id: 's1-2', title: 'La voix dans le brouillard', status: 'progress', words: 1876 },
        { id: 's1-3', title: 'Le choix de Yuki', status: 'draft', words: 450 },
      ]
    },
    {
      id: 'ch2', title: 'Acte I — Le Seuil', open: false,
      scenes: [
        { id: 's2-1', title: 'Traversée du torii', status: 'draft', words: 0 },
        { id: 's2-2', title: 'Rencontre avec Kael', status: 'draft', words: 0 },
      ]
    },
    {
      id: 'ch3', title: 'Acte II — L\'Épreuve', open: false,
      scenes: [
        { id: 's3-1', title: 'Le marché des esprits', status: 'revise', words: 1230 },
        { id: 's3-2', title: 'Trahison sous la lune', status: 'draft', words: 0 },
        { id: 's3-3', title: 'La leçon de Kael', status: 'draft', words: 0 },
      ]
    },
  ],
  characters: [
    { name: 'Yuki Tanaka', role: 'Protagoniste', color: '#8b5cf6' },
    { name: 'Kael', role: 'Mentor / Guide', color: '#06b6d4' },
    { name: 'Haruki', role: 'Antagoniste', color: '#ef4444' },
    { name: 'Grand-mère Sato', role: 'Sage / Gardienne', color: '#f59e0b' },
    { name: 'Rei', role: 'Allié / Esprit', color: '#22c55e' },
  ]
};

const STATUS_MAP = {
  draft:    { label: 'Brouillon', color: 'var(--status-draft)' },
  progress: { label: 'En cours',  color: 'var(--status-progress)' },
  done:     { label: 'Terminé',   color: 'var(--status-done)' },
  revise:   { label: 'À réviser', color: 'var(--status-revise)' },
};

let activeSceneId = 's1-2';
let activeTabId = 'write';

/* ═══════════════════════════════════════════
   RENDER — Chapter tree
   ═══════════════════════════════════════════ */
function renderChapterTree() {
  const tree = document.getElementById('chapterTree');
  tree.innerHTML = '';

  PROJECT.chapters.forEach(ch => {
    // Chapter header
    const header = document.createElement('button');
    header.className = 'chapter-header';
    header.innerHTML = `
      <span class="ch-chevron ${ch.open ? 'open' : ''}">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </span>
      <span class="ch-title">${ch.title}</span>
      <span class="ch-count">${ch.scenes.length}</span>
    `;
    header.onclick = () => {
      ch.open = !ch.open;
      renderChapterTree();
    };
    tree.appendChild(header);

    // Scenes
    const scenesDiv = document.createElement('div');
    scenesDiv.className = 'chapter-scenes' + (ch.open ? ' open' : '');

    ch.scenes.forEach(sc => {
      const btn = document.createElement('button');
      btn.className = 'scene-btn' + (sc.id === activeSceneId ? ' active' : '');
      btn.innerHTML = `
        <span class="scene-dot" style="background:${STATUS_MAP[sc.status].color}"></span>
        <span class="scene-title">${sc.title}</span>
        <span class="scene-words">${sc.words > 0 ? sc.words.toLocaleString('fr-FR') : '—'}</span>
      `;
      btn.onclick = () => selectScene(sc.id, ch);
      scenesDiv.appendChild(btn);
    });

    // Add scene button
    const addBtn = document.createElement('button');
    addBtn.className = 'add-scene-btn';
    addBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
      Scène
    `;
    addBtn.onclick = () => alert('Nouvelle scène dans : ' + ch.title);
    scenesDiv.appendChild(addBtn);

    tree.appendChild(scenesDiv);
  });
}

function selectScene(sceneId, chapter) {
  activeSceneId = sceneId;
  renderChapterTree();

  // Find scene data
  let scene = null;
  for (const ch of PROJECT.chapters) {
    for (const sc of ch.scenes) {
      if (sc.id === sceneId) { scene = sc; break; }
    }
    if (scene) break;
  }
  if (!scene) return;

  // Update breadcrumb
  const parts = chapter.title.split(' — ');
  document.getElementById('bcAct').textContent = parts[0] || '';
  document.getElementById('bcChapter').textContent = parts[1] || parts[0];
  document.getElementById('bcScene').textContent = scene.title;
  document.getElementById('sceneWords').textContent = scene.words.toLocaleString('fr-FR');

  const st = STATUS_MAP[scene.status];
  const bcStatus = document.getElementById('bcStatus');
  bcStatus.style.background = st.color + '18';
  bcStatus.style.color = st.color;
  bcStatus.querySelector('.bc-dot').style.background = st.color;
  document.getElementById('bcStatusLabel').textContent = st.label;

  // Update editor title
  document.getElementById('editorTitle').textContent = scene.title;
}

/* ═══════════════════════════════════════════
   RENDER — Characters
   ═══════════════════════════════════════════ */
function renderCharacters() {
  const list = document.getElementById('charList');
  list.innerHTML = '';
  PROJECT.characters.forEach(c => {
    const div = document.createElement('div');
    div.className = 'char-item';
    div.innerHTML = `
      <div class="char-avatar" style="background:${c.color}18; border:1.5px solid ${c.color}40; color:${c.color}">
        ${c.name[0]}
      </div>
      <div>
        <div class="char-info-name">${c.name}</div>
        <div class="char-info-role">${c.role}</div>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ═══════════════════════════════════════════
   TABS
   ═══════════════════════════════════════════ */
function switchTab(tabId, btnEl) {
  activeTabId = tabId;

  // Update main tab buttons
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  // Update atelier buttons
  document.querySelectorAll('.atelier-btn').forEach(b => b.classList.remove('active'));

  if (btnEl) btnEl.classList.add('active');

  // Also highlight the matching tab-btn if clicking an atelier btn
  const mainBtns = ['write','tableau','characters','notes','stats'];
  if (mainBtns.includes(tabId)) {
    document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
  } else {
    document.querySelector(`.atelier-btn[data-tab="${tabId}"]`)?.classList.add('active');
  }

  // Show correct panel
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  const panel = document.getElementById('panel-' + tabId);
  if (panel) panel.style.display = '';

  // Expand sidebar if collapsed
  const sidebar = document.getElementById('sidebar');
  if (sidebar.classList.contains('collapsed')) {
    toggleSidebar();
  }
}

/* ═══════════════════════════════════════════
   ATELIER DRAWER
   ═══════════════════════════════════════════ */
function toggleAtelier() {
  const toggle = document.getElementById('atelierToggle');
  const panel = document.getElementById('atelierPanel');
  toggle.classList.toggle('open');
  panel.classList.toggle('open');
}

/* ═══════════════════════════════════════════
   SIDEBAR COLLAPSE
   ═══════════════════════════════════════════ */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('collapseBtn');
  sidebar.classList.toggle('collapsed');

  // Flip arrow direction
  const isCollapsed = sidebar.classList.contains('collapsed');
  btn.innerHTML = isCollapsed
    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>'
    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>';
}

/* ═══════════════════════════════════════════
   OVERFLOW MENU
   ═══════════════════════════════════════════ */
function toggleMore() {
  document.getElementById('overflowMenu').classList.toggle('open');
}

/* ═══════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════ */
function toggleSearch() {
  const overlay = document.getElementById('searchOverlay');
  overlay.classList.toggle('open');
  if (overlay.classList.contains('open')) {
    setTimeout(() => document.getElementById('searchInput').focus(), 100);
  }
}

/* ═══════════════════════════════════════════
   POMODORO
   ═══════════════════════════════════════════ */
let pomoInterval = null;
let pomoSeconds = 25 * 60;
let pomoRunning = false;
let pomoSessionCount = 0;

function togglePomo() {
  document.getElementById('pomoPopup').classList.toggle('open');
  document.getElementById('pomoToggle').classList.toggle('active');
}

function updatePomoDisplay() {
  const m = Math.floor(pomoSeconds / 60).toString().padStart(2, '0');
  const s = (pomoSeconds % 60).toString().padStart(2, '0');
  document.getElementById('pomoTime').textContent = m + ':' + s;
}

function startPomo() {
  if (pomoRunning) {
    clearInterval(pomoInterval);
    pomoRunning = false;
    document.getElementById('pomoStartBtn').textContent = 'Reprendre';
    return;
  }
  pomoRunning = true;
  document.getElementById('pomoStartBtn').textContent = 'Pause';
  pomoInterval = setInterval(() => {
    pomoSeconds--;
    if (pomoSeconds <= 0) {
      clearInterval(pomoInterval);
      pomoRunning = false;
      pomoSessionCount++;
      document.getElementById('pomoSessions').textContent = pomoSessionCount;
      document.getElementById('pomoStartBtn').textContent = 'Démarrer';
      pomoSeconds = 25 * 60;
      alert('Pomodoro terminé ! Prenez une pause.');
    }
    updatePomoDisplay();
  }, 1000);
}

function resetPomo() {
  clearInterval(pomoInterval);
  pomoRunning = false;
  pomoSeconds = 25 * 60;
  updatePomoDisplay();
  document.getElementById('pomoStartBtn').textContent = 'Démarrer';
}

/* ═══════════════════════════════════════════
   FOCUS MODE
   ═══════════════════════════════════════════ */
function toggleFocus() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(() => {});
  } else {
    document.exitFullscreen();
  }
}

/* ═══════════════════════════════════════════
   SAVE
   ═══════════════════════════════════════════ */
function saveProject() {
  const badge = document.getElementById('saveStatus');
  badge.textContent = 'Sauvé ✓';
  badge.style.color = 'var(--status-done)';
  setTimeout(() => { badge.textContent = 'Sauvé'; }, 1500);
}

/* ═══════════════════════════════════════════
   UTILS
   ═══════════════════════════════════════════ */
function insertText(text) {
  document.execCommand('insertText', false, text);
}

// Update word count on editor input
document.addEventListener('DOMContentLoaded', () => {
  const body = document.getElementById('editorBody');
  body.addEventListener('input', () => {
    const text = body.innerText.trim();
    const count = text ? text.split(/\s+/).length : 0;
    document.getElementById('sceneWords').textContent = count.toLocaleString('fr-FR');
  });
});

// Close menus on outside click
document.addEventListener('click', (e) => {
  // Overflow menu
  if (!e.target.closest('#moreBtn') && !e.target.closest('#overflowMenu')) {
    document.getElementById('overflowMenu').classList.remove('open');
  }
  // Pomo popup
  if (!e.target.closest('#pomoPopup') && !e.target.closest('#pomoToggle')) {
    document.getElementById('pomoPopup').classList.remove('open');
    document.getElementById('pomoToggle').classList.remove('active');
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+F → search
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    toggleSearch();
  }
  // Escape → close overlays
  if (e.key === 'Escape') {
    document.getElementById('searchOverlay').classList.remove('open');
    document.getElementById('overflowMenu').classList.remove('open');
    document.getElementById('pomoPopup').classList.remove('open');
    document.getElementById('pomoToggle').classList.remove('active');
  }
  // Ctrl+S → save
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveProject();
  }
});

/* ═══════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════ */
document.getElementById('projectName').textContent = PROJECT.name;
renderChapterTree();
renderCharacters();

// Set initial breadcrumb status
const initScene = PROJECT.chapters[0].scenes[1];
const st = STATUS_MAP[initScene.status];
const bcStatus = document.getElementById('bcStatus');
bcStatus.style.background = st.color + '18';
bcStatus.style.color = st.color;
bcStatus.querySelector('.bc-dot').style.background = st.color;
</script>

</body>
</html>
